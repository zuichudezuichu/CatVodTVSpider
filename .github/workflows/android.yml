name: android_build_test
on: [workflow_dispatch]

jobs:
  build-test-apk:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    env:
      ANDROID_SDK_ROOT: /home/runner/android-sdk
      TEST_SUFFIX: "-TEST-$(date +%Y%m%d%H%M)"
      # ÂÖúÂ∫ïÔºöÁõ¥Êé•ÈÖçÁΩÆ‰ªìÂ∫ìÂú∞ÂùÄÔºàÈÅøÂÖçÊñá‰ª∂Áº∫Â§±Ôºâ
      DEFAULT_PROJECT_URL: "https://github.com/zuichudezuichu/Box"
    steps:
      # 1. ÊãâÂèñ‰ª£Á†ÅÔºàÁ°Æ‰øùÂåÖÂê´Ê†πÁõÆÂΩïÊñá‰ª∂Ôºâ
      - name: Checkout code (full repo)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # ÊãâÂèñÂÆåÊï¥‰ªìÂ∫ìÔºàÂåÖÂê´Ê†πÁõÆÂΩïÊñá‰ª∂Ôºâ

      # 2. Ê†°È™åÂπ∂Ëé∑Âèñ‰ªìÂ∫ìÂú∞ÂùÄÔºàÊ†∏ÂøÉ‰øÆÂ§çÔºöÊñá‰ª∂Áº∫Â§±Êó∂Áî®ÂÖúÂ∫ïÂú∞ÂùÄÔºâ
      - name: Get project URL (with fallback)
        run: |
          # Ê≠•È™§1ÔºöÊ£ÄÊü•Ê†πÁõÆÂΩïÊòØÂê¶Êúâproject-to-buildÊñá‰ª∂
          if [ -f "project-to-build" ]; then
            # ËØªÂèñÊñá‰ª∂‰∏≠ÁöÑÂú∞ÂùÄ
            RAW_URL=$(cat project-to-build | tr -d '\r\n \t' | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            echo "‚úÖ Found project-to-build file, URL: $RAW_URL"
            # Á©∫ÂÄºÊ†°È™åÔºöËã•Êñá‰ª∂‰∏∫Á©∫ÂàôÁî®ÂÖúÂ∫ïÂú∞ÂùÄ
            if [ -z "$RAW_URL" ]; then
              echo "‚ö†Ô∏è project-to-build file is empty, using default URL"
              PROJECT_URL="${{ env.DEFAULT_PROJECT_URL }}"
            else
              # Ëá™Âä®Ë°•ÂÖ®.gitÂêéÁºÄ
              if [[ "$RAW_URL" =~ ^https://.* && ! "$RAW_URL" =~ \.git$ ]]; then
                PROJECT_URL="${RAW_URL}.git"
              else
                PROJECT_URL="$RAW_URL"
              fi
            fi
          else
            # Ê≠•È™§2ÔºöÊñá‰ª∂‰∏çÂ≠òÂú®Êó∂ÔºåÁõ¥Êé•‰ΩøÁî®ÂÖúÂ∫ïÂú∞ÂùÄ
            echo "‚ö†Ô∏è project-to-build file not found, using default URL"
            PROJECT_URL="${{ env.DEFAULT_PROJECT_URL }}"
          fi
          
          # ÊúÄÁªàÊ†°È™åÂú∞ÂùÄÊ†ºÂºè
          if [[ ! "$PROJECT_URL" =~ ^(https?://|git@) ]]; then
            echo "‚ùå Invalid project URL: $PROJECT_URL"
            exit 1
          fi
          
          echo "‚úÖ Final project URL: $PROJECT_URL"
          echo "PROJECT_URL=$PROJECT_URL" >> $GITHUB_ENV

      # 3. ÂÆâË£ÖÁ≥ªÁªü‰æùËµñ
      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y unzip zip wget openjdk-11-jdk lib32stdc++6 lib32z1 git
          git --version && java -version

      # 4. ÈÖçÁΩÆGitÔºàÈÄÇÈÖçÁßÅÊúâ‰ªìÂ∫ì+ÁΩëÁªúÂä†ÈÄüÔºâ
      - name: Configure Git
        run: |
          # ÁßÅÊúâ‰ªìÂ∫ìPATÈÖçÁΩÆÔºàÂ¶ÇÊúâÔºâ
          if [ -n "${{ secrets.GITHUB_PAT }}" ]; then
            git config --global url."https://${{ secrets.GITHUB_PAT }}:@github.com/".insteadOf "https://github.com/"
          fi
          # ÁΩëÁªúÂä†ÈÄü+Ë∂ÖÊó∂ÈÖçÁΩÆ
          git config --global http.timeout 300
          git config --global url."https://mirror.ghproxy.com/https://github.com/".insteadOf "https://github.com/"

      # 5. ÂéüÁîüÂÆâË£ÖAndroid SDK
      - name: Install Android SDK
        run: |
          mkdir -p $ANDROID_SDK_ROOT/cmdline-tools
          cd $ANDROID_SDK_ROOT/cmdline-tools
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O sdk.zip
          unzip -q sdk.zip
          mv cmdline-tools latest
          
          export PATH=$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$PATH
          yes | sdkmanager --licenses > /dev/null
          sdkmanager "platforms;android-33" "build-tools;33.0.2" "platform-tools"

      # 6. ÂÖãÈöÜÈ°πÁõÆÔºàÂ§öËΩÆÈáçËØïÔºâ
      - name: Clone project (with retry)
        run: |
          rm -rf project
          CLONE_SUCCESS=0
          
          # 3Ê¨°ÈáçËØïÂÖãÈöÜ
          for i in {1..3}; do
            echo "üîπ Attempt $i: Clone ${{ env.PROJECT_URL }}"
            if git clone --depth=1 --timeout=300 ${{ env.PROJECT_URL }} project; then
              CLONE_SUCCESS=1
              break
            fi
            echo "‚ö†Ô∏è Attempt $i failed, waiting 5s..."
            sleep 5
          done
          
          if [ $CLONE_SUCCESS -eq 0 ]; then
            echo "‚ùå Failed to clone project!"
            exit 1
          fi
          
          chmod -R 755 project
          echo "‚úÖ Clone succeeded!"

      # 7. ÈÖçÁΩÆGradleÈïúÂÉè
      - name: Gradle mirror
        run: |
          mkdir -p ~/.gradle
          echo "allprojects{repositories{maven{url 'https://maven.aliyun.com/repository/public'}google()mavenCentral()}}" > ~/.gradle/init.gradle

      # 8. ÊûÑÂª∫ÊµãËØïÁâàAPK
      - name: Build TEST APK
        working-directory: ./project
        run: |
          if [ ! -f "gradlew" ]; then
            echo "‚ö†Ô∏è Generating gradlew..."
            gradle wrapper --gradle-version 7.6
          fi
          chmod +x gradlew
          
          export ANDROID_HOME=$ANDROID_SDK_ROOT
          export PATH=$ANDROID_SDK_ROOT/platform-tools:$ANDROID_SDK_ROOT/build-tools/33.0.2:$PATH
          
          ./gradlew clean assembleDebug -PtestBuild=true --no-daemon --stacktrace -Xmx3072m
          
          APK_FILE=$(find . -name "*.apk" -path "*/build/outputs/apk/debug/*.apk" | grep -v unaligned | head -1)
          if [ -z "$APK_FILE" ]; then
            echo "‚ùå No TEST APK generated!"
            exit 1
          fi
          
          mkdir -p output
          mv "$APK_FILE" "output/test-apk${{ env.TEST_SUFFIX }}.apk"
          echo "‚úÖ Built TEST APK: $(ls output/*.apk)"

      # 9. ‰∏ä‰º†ÊµãËØïÁâàAPK
      - name: Upload TEST APK
        uses: actions/upload-artifact@v4
        with:
          name: test-apk
          path: ./project/output/*.apk
          retention-days: 3
          if-no-files-found: warn
